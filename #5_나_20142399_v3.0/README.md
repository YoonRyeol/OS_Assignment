# 역페이지 테이블

## 1. 개요 

본 과제는 inverted page table을 구현함으로써 가상 메모리 page allocator를 이해하고, level hash를 구현하고, 역페이지 테이블을 구현하는 것이 목표이다.

SSUOS는 가상메모리와 실제메모리를 사용한다. 실제 메모리는 RAM을 사용하는데 반해 가상메모리는 디스크를 사용한다. 디스크 일부를 마치 확장된 RAM처럼 쓰게하는 것이다. 커널이 RAM에 적재된 메모리 블록 중 블록 된 것을 디스크에 저장함으로써 사용가능한 메모리 영역을 늘리는 기법이다. 이 suspend된 프로세스가 다시 필요해지면 디스크에 저장된 해당 프로세스의 메모리 블록이 다시 RAM에 적재된다. 프로세스의 할당된 가상 메모리의 주소들은 실제 메모리 공간에 매핑되어 RAM에 로드되어 사용된다.

SSUOS는 가상 메모리를 ‘페이지’로써 관리하고 있다. 페이징 기법은 가상 메모리를 모두 같은 크기의 블록으로 관리하는 기법으로 이 블록을 page라고 한다. (실제 메모리 블록은 frame이라고 한다.) 

가상 메모리를 구현하는 것은 가상 메모리가 참조하는 page 주소를 실제 메모리 frame 주소로 변환하는 것이다. 이는 page 주소가 페이지 테이블을 통해 frame 주소로 변경되어 메모리에 접근함으로써 가능하다.

이번 과제에서 구현해야 하는 것은 결국 Level Hash를 이용한 inverted page table을 구현하는 것인데, inverted page table은 가상 메모리 주소를 물리 메모리 주소로 매핑하여 가상 메모리를 관리할 수 있도록 하는 테이블이고, level hash는 inverted page table을 구현하기 위한 하나의 hashing 기법이다.

Inverted page table, 역페이지 테이블은 많은 프로세스를 생성하면, 페이지 테이블이 차지하는 메모리의 양이 많아지는 것을 해결하기 위한 방법이다. 전체 시스템에서 하나의 테이블을 가지며 물리 메모리의 각 frame마다 하나의 entry를 할당한다. 가상 주소 중 페이지번호 부분은 간단한 hashing을 통해 특정 hash value로 사상된다. 즉, hash value는 역페이지 테이블에 대한 인덱스로 사용된다. 역페이지의 장점으로는 논리 페이지마다 항목을 가지는 대신 물리 프레임에 대응되는 항목만 테이블에 저장하기 때문에 메모리에서 훨씬 더 작은 공간을 점유한다. 단점으로는 주소 변환 시간이 더 오래 걸릴 수 있으며 프레임에 따라 저장되어 있어 탐색은 비효율적이다. 역페이지 테이블을 사용하는 시스템에서의 메모리 공유는 어렵다. 페이지 테이블이 공유된 물리 주소에 대해 하나의 가상주소를 매핑하기에 매핑되지 못한 다른 가상 주소가 공유된 영역을 참조하게 되면 페이지 폴트가 발생한다.

이번 과제는 Level Hash가 hash 기능을 담당하고 있다. Level Hash는 4개의 슬롯으로 이루어지는 하나의 버킷들의 집합으로 이루어져 있으며 Top Bucket과 Bottom Bucket으로 이루어지는데 Top Bucket이 Bottom Bucket의 2배수이고 2개의 Top Bucket이 1개의 Bottom Bucket과 대응된다. 

Level Hash는 key값이 같은 원소들이 생기는 collision에 대응하기 위해 하나의 key값에 대해서 4개의 Bucket, 총 20개의 슬롯이 대응하고, 이를 넘어도 임의의 슬롯에 원소를 넣음으로써 대응하고 있다. 이러한 식으로 오버플로를 관리하고 있다.

## 2. 상세설계

### 2-1. 구현

* #### hashing.h
 
#### 1. typedef struct level_bucket

기존의 level_bucket 구조체에 int num 변수를 추가로 선언해 주었다. 이 변수는 현재 슬롯에 얼마나 많은 원소가 있는지 확인하기 위한 변수이다. 따라서 원소가 삽입되고 삭제될 때 이 변수의 값은 수정된다.

- #### hasing.c

#### 1. void init_hash_table(void)

 hash_table을 초기화하기 위한 함수이다. hash_table의 모든 버킷들의 num 변수를 0으로 초기화하며 각 슬롯들에 대응하는 토큰들의 값을 0으로 초기화한다.


#### 2. void insert_elem(uint32_t addr, uint32_t capacity)

 hash_table에 원소를 넣기 위한 함수이다. 페이지의 주소를 addr인자로 받고, 해당 주소에 대응하는 2개의 해시값을 F_IDX(), S_IDX()를 이용하여 계산한다. 그 뒤에 먼저 Top Bucket에 페이지 주소를 넣을 수 있다면 넣는다. 첫 번째 해쉬값에 해당하는 인덱스의 버킷의 0번지 슬롯에 넣을 수 있는지 먼저 확인하고 넣을 수 없다면 두 번째 해쉬값에 해당하는 인덱스의 버킷의 0번지 슬롯에 넣을 수 있는지 확인한다. 첫 번째 인덱스의 버킷, 두 번째 인덱스의 버킷을 번갈아가며 확인하면서 오름차순으로 넣을 수 있는 슬롯이 있는지 확인한다.
 
 Top Bucket에 넣을 수 없다면 각 Top Bucket의 인덱스에 대응하는 Bottom Bucket을 같은 방법으로 확인하면서 원소를 넣으려고 시도한다. 이 경우에도 넣을 수가 없다면 원소 이동을 시키고 빈 자리에 새로운 원소를 삽입하여야 한다. 원소이동은 Top Bucket의 슬롯부터 오름차순으로 슬롯 하나가 원래 들어갈 수 있었던 다른 인덱스의 버킷에 원소를 옮길 수 있다면 옮기고 그렇지 않다면 현재 버킷의 다른 슬롯을 확인하여 그러한지 확인한다. 옮기고 난 뒤 옮기고 생긴 빈 자리에 현재 삽입하려는 원소를 삽입한다.
 

#### 3. void delete_elem(uint32_t addr, uint32_t capacity)

 hash_table의 원소를 삭제하기 위한 함수이다. 삭제하려는 page의 주소를 addr인자로 받는다. F_IDX()와 S_IDX()를 이용하여 해당 원소가 들어갈 수 있는 top level bucket과 bottom level bucket, 총 4개의 버킷의 슬롯을 오름차순으로 확인하여 key, value 값이 같고, token이 1인 경우 token을 0으로 바꿔 해당 슬롯이 사용중이지 않음을 설정함으로써 원소를 삭제한다.
 

- #### palloc.c

#### 1. uint32_t *palloc_get_multiple (size_t page_cnt)

 이 함수는 페이지를 할당해주는 함수이다. inverted page table을 구현하면서 이 함수에서 수정해야 했던 것은 이 함수에서 page가 할당이 되고 난 뒤, page의 가상 주소를 level hash의 hash table에 등록시켜주는 작업을 추가시켜주어야 했다. 따라서 해당 함수에서 page할당 작업이 마무리 된 후, insert_elem()를 추가시킴으로써 테이블에 등록시키는 작업을 구현했다. 
 

#### 2. void palloc_free_multiple(void *pages, size_t page_cnt)

 이 함수는 할당된 페이지를 해제하는 함수이다. 페이지를 해제하면서 hash table에 등록된 페이지의 주소를 삭제하기 위해, 해당 함수가 시작될 때, delete_elem()을 호출하여 table에서 해당 페이지를 삭제하고 페이지 해제하는 작업을 수행하도록 구현했다.

### 2-2. 전체 구성도

![image](https://user-images.githubusercontent.com/40683361/118365326-3105ec80-b5d7-11eb-85ed-46eb3a1f3b6e.png)

 page 할당, 해제 및 page관리에 관한 전체 구성은 다음과 같다고 할 수 있다. 먼저 페이지 할당의 경우, 직접 페이지 할당을 위해 사용자가 직접 요청할 수도 있지만 더 자연스러운 경우는 프로세스가 시작되면서 page를 할당받는 경우라고 할 수 있다. 이 때 SSUOS는 페이지를 할당해주면서 level hash table에 해당 페이지 주소를 삽입함으로써 가상 메모리를 관리한다.
 
 page 해제의 경우도 마찬가지이다. 사용자가 할당요청을 할 수 있는 한편 프로세스가 종료되면서 page 해제를 요청할 수 있다. 이때 SSUOS는 palloc_free_multiple()로 페이지를 해제하는데 이 안에서 delete_elem()이 호출하여 페이지 테이블에서 해당 페이지를 삭제한다.
 
